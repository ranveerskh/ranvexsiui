<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    input, select, button {
      padding: 10px;
      margin: 5px;
      width: calc(100% - 20px);
      max-width: 400px;
    }
    .list {
      margin-top: 10px;
    }
    .list div {
      margin: 5px 0;
      background: #eee;
      padding: 10px;
      border-radius: 5px;
    }
    .list button {
      float: right;
      background: red;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>Admin Panel</h1>

  <div class="section">
    <h2>Departments</h2>
    <input type="text" id="depName" placeholder="Department Name" />
    <input type="text" id="depImage" placeholder="Background Image URL" />
    <button onclick="addDepartment()">Add / Update Department</button>
    <div class="list" id="departmentsList"></div>
  </div>

  <div class="section">
    <h2>Sub-Departments</h2>
    <select id="parentDep"></select>
    <input type="text" id="subName" placeholder="Sub-Department Name" />
    <button onclick="addSubDepartment()">Add Sub-Department</button>
    <div class="list" id="subsList"></div>
  </div>

  <div class="section">
    <h2>Links</h2>
    <select id="linkDep"></select>
    <select id="linkSub"></select>
    <input type="text" id="linkName" placeholder="Link Name" />
    <input type="text" id="linkUrl" placeholder="Link URL" />
    <input type="text" id="linkColor" placeholder="Background Color (e.g., #4CAF50)" />
    <button onclick="addLink()">Add Link</button>
    <div class="list" id="linksList"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoUb1kEA8bo0NaqSTDQSTtH4fWNdmJrAw",
      authDomain: "ranvexsi-ui.firebaseapp.com",
      projectId: "ranvexsi-ui",
      storageBucket: "ranvexsi-ui.firebasestorage.app",
      messagingSenderId: "639916549058",
      appId: "1:639916549058:web:2c14514e7d00aeaca52c5b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let departments = {};

    async function loadDepartments() {
      const snap = await getDoc(doc(db, "structure", "departments"));
      if (snap.exists()) {
        departments = snap.data();
        renderDepartments();
        populateDepDropdowns();
      }
    }

    function renderDepartments() {
      const list = document.getElementById("departmentsList");
      list.innerHTML = "";
      for (const dep in departments) {
        const div = document.createElement("div");
        div.textContent = dep;
        const del = document.createElement("button");
        del.textContent = "✕";
        del.onclick = () => deleteDepartment(dep);
        div.appendChild(del);
        list.appendChild(div);
      }
    }

    async function addDepartment() {
      const name = document.getElementById("depName").value.trim();
      const img = document.getElementById("depImage").value.trim();
      if (!name) return alert("Department name required");

      departments[name] = {
        ...(departments[name] || {}),
        image: img,
        subs: departments[name]?.subs || []
      };
      await setDoc(doc(db, "structure", "departments"), departments);
      loadDepartments();
    }

    async function deleteDepartment(name) {
      delete departments[name];
      await setDoc(doc(db, "structure", "departments"), departments);
      loadDepartments();
    }

    function populateDepDropdowns() {
      const selects = [document.getElementById("parentDep"), document.getElementById("linkDep")];
      selects.forEach(sel => {
        sel.innerHTML = "";
        for (const dep in departments) {
          const opt = document.createElement("option");
          opt.value = dep;
          opt.textContent = dep;
          sel.appendChild(opt);
        }
      });
      populateSubDropdown();
    }

    document.getElementById("linkDep").addEventListener("change", populateSubDropdown);

    function populateSubDropdown() {
      const dep = document.getElementById("linkDep").value;
      const subs = departments[dep]?.subs || [];
      const sel = document.getElementById("linkSub");
      sel.innerHTML = "";
      subs.forEach(sub => {
        const opt = document.createElement("option");
        opt.value = sub;
        opt.textContent = sub;
        sel.appendChild(opt);
      });
      loadLinks();
    }

    async function addSubDepartment() {
      const dep = document.getElementById("parentDep").value;
      const sub = document.getElementById("subName").value.trim();
      if (!dep || !sub) return alert("Both fields required");
      if (!departments[dep].subs.includes(sub)) {
        departments[dep].subs.push(sub);
        await setDoc(doc(db, "structure", "departments"), departments);
        loadDepartments();
      }
    }

    const linksList = document.getElementById("linksList");

    async function loadLinks() {
      linksList.innerHTML = "";
      const dep = document.getElementById("linkDep").value;
      const sub = document.getElementById("linkSub").value;
      if (!dep || !sub) return;
      const docSnap = await getDoc(doc(db, "links", `${dep}-${sub}`));
      if (docSnap.exists()) {
        const items = docSnap.data().items || [];
        items.forEach((link, index) => {
          const div = document.createElement("div");
          div.style.background = link.color;
          div.textContent = link.name;
          const del = document.createElement("button");
          del.textContent = "✕";
          del.onclick = async () => {
            items.splice(index, 1);
            await setDoc(doc(db, "links", `${dep}-${sub}`), { items });
            loadLinks();
          };
          div.appendChild(del);
          linksList.appendChild(div);
        });
      }
    }

    async function addLink() {
      const dep = document.getElementById("linkDep").value;
      const sub = document.getElementById("linkSub").value;
      const name = document.getElementById("linkName").value.trim();
      const url = document.getElementById("linkUrl").value.trim();
      const color = document.getElementById("linkColor").value.trim() || "#4CAF50";
      if (!name || !url) return alert("Link name and URL required");
      const docRef = doc(db, "links", `${dep}-${sub}`);
      const docSnap = await getDoc(docRef);
      const links = docSnap.exists() ? docSnap.data().items || [] : [];
      links.push({ name, url, color });
      await setDoc(docRef, { items: links });
      loadLinks();
    }

    loadDepartments();
  </script>
</body>
</html>
