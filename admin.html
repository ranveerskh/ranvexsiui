<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <style>
    :root {
      --bg: #f4f4f4;
      --text: #000;
      --section: #fff;
    }
    body.dark {
      --bg: #121212;
      --text: #eee;
      --section: #1f1f1f;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }

    h1 {
      text-align: center;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #4caf50;
      color: white;
      padding: 10px 20px;
      margin-bottom: 20px;
      border-radius: 8px;
    }

    .section {
      background: var(--section);
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    input, select, button {
      padding: 10px;
      margin: 5px;
      width: calc(100% - 20px);
      max-width: 400px;
    }

    button {
      cursor: pointer;
    }

    .list {
      margin-top: 10px;
    }

    .list div {
      margin: 5px 0;
      background: #ccc;
      color: #000;
      padding: 10px;
      border-radius: 5px;
      position: relative;
    }

    .list button {
      position: absolute;
      right: 10px;
      top: 6px;
      background: red;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    .dark .list div {
      background: #333;
      color: #fff;
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <h1>Admin Panel</h1>
    <button id="darkModeToggle">ðŸŒ™</button>
  </div>

  <div class="section">
    <h2>Departments</h2>
    <input type="text" id="depName" placeholder="Department Name" />
    <input type="text" id="depImage" placeholder="Background Image URL" />
    <button id="addDepBtn">Add / Update Department</button>
    <div class="list" id="departmentsList"></div>
    <button id="saveAllBtn">ðŸ’¾ Save All</button>
  </div>

  <div class="section">
    <h2>Sub-Departments</h2>
    <select id="parentDep"></select>
    <input type="text" id="subName" placeholder="Sub-Department Name" />
    <button id="addSubBtn">Add Sub-Department</button>
    <div class="list" id="subsList"></div>
  </div>

  <div class="section">
    <h2>Links</h2>
    <select id="linkDep"></select>
    <select id="linkSub"></select>
    <input type="text" id="linkName" placeholder="Link Name" />
    <input type="text" id="linkUrl" placeholder="Link URL" />
    <input type="text" id="linkColor" placeholder="Background Color (e.g., #4CAF50)" />
    <button id="addLinkBtn">Add Link</button>
    <div class="list" id="linksList"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoUb1kEA8bo0NaqSTDQSTtH4fWNdmJrAw",
      authDomain: "ranvexsi-ui.firebaseapp.com",
      projectId: "ranvexsi-ui",
      storageBucket: "ranvexsi-ui.firebasestorage.app",
      messagingSenderId: "639916549058",
      appId: "1:639916549058:web:2c14514e7d00aeaca52c5b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let departments = {};

    async function loadDepartments() {
      const snap = await getDoc(doc(db, "structure", "departments"));
      if (snap.exists()) {
        departments = snap.data();
        renderDepartments();
        populateDropdowns();
      }
    }

    function renderDepartments() {
      const list = document.getElementById("departmentsList");
      list.innerHTML = "";
      for (const dep in departments) {
        const div = document.createElement("div");
        div.textContent = `${dep}`;
        const del = document.createElement("button");
        del.textContent = "âœ•";
        del.onclick = () => {
          delete departments[dep];
          renderDepartments();
          populateDropdowns();
        };
        div.appendChild(del);
        list.appendChild(div);
      }
    }

    function addOrUpdateDepartment() {
      const name = document.getElementById("depName").value.trim();
      const image = document.getElementById("depImage").value.trim();
      if (!name) return alert("Please enter a department name");
      departments[name] = {
        image,
        subs: departments[name]?.subs || []
      };
      renderDepartments();
      populateDropdowns();
    }

    async function saveDepartments() {
      await setDoc(doc(db, "structure", "departments"), departments);
      alert("Saved to Firebase");
    }

    function populateDropdowns() {
      const parentDep = document.getElementById("parentDep");
      const linkDep = document.getElementById("linkDep");

      parentDep.innerHTML = "";
      linkDep.innerHTML = "";

      for (const dep in departments) {
        const opt1 = new Option(dep, dep);
        const opt2 = new Option(dep, dep);
        parentDep.appendChild(opt1);
        linkDep.appendChild(opt2);
      }
      populateSubDropdown();
      renderSubDepartments();
    }

    function addSubDepartment() {
      const dep = document.getElementById("parentDep").value;
      const sub = document.getElementById("subName").value.trim();
      if (!dep || !sub) return alert("Both department and sub-department are required");
      if (!departments[dep].subs.includes(sub)) {
        departments[dep].subs.push(sub);
        renderSubDepartments();
        populateSubDropdown();
      }
    }

    function renderSubDepartments() {
      const subsList = document.getElementById("subsList");
      subsList.innerHTML = "";
      const dep = document.getElementById("parentDep").value;
      const subs = departments[dep]?.subs || [];
      subs.forEach((sub, index) => {
        const div = document.createElement("div");
        div.textContent = sub;
        const del = document.createElement("button");
        del.textContent = "âœ•";
        del.onclick = () => {
          departments[dep].subs.splice(index, 1);
          renderSubDepartments();
          populateSubDropdown();
        };
        div.appendChild(del);
        subsList.appendChild(div);
      });
    }

    document.getElementById("linkDep").addEventListener("change", populateSubDropdown);

    function populateSubDropdown() {
      const dep = document.getElementById("linkDep").value;
      const linkSub = document.getElementById("linkSub");
      linkSub.innerHTML = "";
      (departments[dep]?.subs || []).forEach(sub => {
        const opt = new Option(sub, sub);
        linkSub.appendChild(opt);
      });
      renderLinks();
    }

    async function addLink() {
      const dep = document.getElementById("linkDep").value;
      const sub = document.getElementById("linkSub").value;
      const name = document.getElementById("linkName").value.trim();
      const url = document.getElementById("linkUrl").value.trim();
      const color = document.getElementById("linkColor").value.trim() || "#4CAF50";
      if (!name || !url) return alert("Please enter link name and URL");

      const docId = `${dep}-${sub}`;
      const ref = doc(db, "links", docId);
      const snap = await getDoc(ref);
      const items = snap.exists() ? snap.data().items || [] : [];
      items.push({ name, url, color });
      await setDoc(ref, { items });
      renderLinks();
    }

    async function renderLinks() {
      const dep = document.getElementById("linkDep").value;
      const sub = document.getElementById("linkSub").value;
      const docId = `${dep}-${sub}`;
      const ref = doc(db, "links", docId);
      const snap = await getDoc(ref);
      const list = document.getElementById("linksList");
      list.innerHTML = "";
      if (snap.exists()) {
        const items = snap.data().items || [];
        items.forEach((link, index) => {
          const div = document.createElement("div");
          div.style.background = link.color;
          div.textContent = link.name;
          const del = document.createElement("button");
          del.textContent = "âœ•";
          del.onclick = async () => {
            items.splice(index, 1);
            await setDoc(ref, { items });
            renderLinks();
          };
          div.appendChild(del);
          list.appendChild(div);
        });
      }
    }

    // DARK MODE
    document.getElementById("darkModeToggle").addEventListener("click", () => {
      document.body.classList.toggle("dark");
    });

    // EVENT BINDING (FIXING Add button)
    document.getElementById("addDepBtn").addEventListener("click", addOrUpdateDepartment);
    document.getElementById("saveAllBtn").addEventListener("click", saveDepartments);
    document.getElementById("addSubBtn").addEventListener("click", addSubDepartment);
    document.getElementById("addLinkBtn").addEventListener("click", addLink);

    loadDepartments();
  </script>
</body>
</html>
