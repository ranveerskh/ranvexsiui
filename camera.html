<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="viewport-fit=cover,width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>ranvexsi barcode scanner</title>
<link rel="manifest" href='data:application/manifest+json,{"name":"ranvexsi barcode scanner","short_name":"RBS","start_url":".","display":"standalone","background_color":"#0f1220","theme_color":"#5e7bff"}'>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{
  --bg:#0f1220; --card:#171b2e; --ink:#eaf0ff; --muted:#a8b2d1; --line:#262c46; --accent:#5e7bff;
  --safe-top: env(safe-area-inset-top,0px);
  --safe-bottom: env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
header{
  position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#121633,rgba(18,22,51,.7));
  padding: calc(8px + var(--safe-top)) 14px 10px; border-bottom:1px solid var(--line);
  display:flex; align-items:center; gap:10px; justify-content:space-between;
}
h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.2px}
.badge{font-size:11px;color:#cfd7ff;opacity:.8}
.wrap{padding:14px}
.card{
  background:var(--card); border:1px solid var(--line); border-radius:14px; overflow:hidden;
}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:10px;border-bottom:1px solid var(--line);background:#141836}
.control{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
label.small{font-size:12px;color:#aeb7d9;display:flex;gap:6px;align-items:center}
select, input[type="checkbox"]{accent-color:#5e7bff}
button{
  appearance:none;border:1px solid transparent;background:var(--accent);color:#fff;
  padding:9px 12px;border-radius:10px;font-weight:600;font-size:14px;cursor:pointer
}
button.ghost{background:transparent;border-color:#2f3761;color:#cbd3ff}
button.warn{background:#b54747}
button:disabled{opacity:.5;pointer-events:none}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.input{
  background:#0f1330;border:1px solid #2b3261;border-radius:10px;padding:10px 12px;color:var(--ink);
}
.video-wrap{position:relative;background:#0b0e22}
video{width:100%;height:auto;background:#000}
.scan-frame{
  position:absolute;inset:15% 20%;border:2px solid rgba(94,123,255,.85);border-radius:12px;
  box-shadow:0 0 0 9999px rgba(0,0,0,.35) inset;pointer-events:none
}
.status{padding:10px;font-size:12px;color:#c5ccef;border-top:1px dashed var(--line)}
.table-wrap{max-height:40vh;overflow:auto;border-top:1px solid var(--line)}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid var(--line)}
th{text-align:left;color:#cfd6ff;background:#141836;position:sticky;top:0;z-index:1}
td.qty input{width:70px;text-align:center}
footer{height:calc(12px + var(--safe-bottom))}
.kv{display:flex;gap:6px;align-items:center}
.kv code{background:#0f1330;border:1px solid #2b3261;border-radius:6px;padding:3px 6px;color:#cbd3ff}
.small{font-size:12px;color:#aeb7d9}
.notice{padding:10px;color:#e9edff;background:#262f5e;border-left:3px solid var(--accent);margin-top:12px}
hr.split{border:0;border-top:1px solid #2a3160;margin:8px 0}
.range{display:flex;align-items:center;gap:8px}
.range input[type="range"]{width:160px}
</style>
</head>
<body>
<header>
  <div>
    <h1>ranvexsi barcode scanner</h1>
    <div class="badge">Scan. Count. Copy. Today only.</div>
  </div>
  <div class="kv small"><span>Today:</span><code id="today"></code></div>
</header>

<div class="wrap">
  <div class="card" id="scannerCard">
    <div class="toolbar">
      <div class="row">
        <button id="startBtn">Start camera</button>
        <button id="stopBtn" class="ghost" disabled>Stop</button>
        <button id="flipBtn" class="ghost" disabled>Flip</button>
        <button id="torchBtn" class="ghost" disabled>Torch</button>
      </div>
      <div class="control">
        <label class="small"><input type="checkbox" id="forceZX"> Force ZXing</label>
        <label class="small"><input type="checkbox" id="useROI" checked> Center ROI</label>
        <label class="small">
          Formats
          <select id="formats" multiple size="3">
            <option value="ean_13" selected>EAN-13</option>
            <option value="ean_8" selected>EAN-8</option>
            <option value="upc_a" selected>UPC-A</option>
            <option value="upc_e" selected>UPC-E</option>
            <option value="code_128" selected>Code 128</option>
            <option value="code_39">Code 39</option>
            <option value="itf">ITF</option>
            <option value="qr_code">QR</option>
            <option value="pdf417">PDF417</option>
            <option value="data_matrix">Data Matrix</option>
            <option value="aztec">Aztec</option>
            <option value="codabar">Codabar</option>
          </select>
        </label>
        <div class="range small">
          <span>Zoom</span>
          <input type="range" id="zoom" min="1" max="6" value="1" step="0.1">
        </div>
      </div>
      <div class="row">
        <input id="manualInput" class="input" placeholder="Enter barcode manually" inputmode="numeric" autocomplete="off">
        <button id="addManualBtn" class="ghost">Add</button>
      </div>
    </div>

    <div class="video-wrap" id="videoWrap">
      <video id="video" playsinline muted></video>
      <div class="scan-frame"></div>
      <!-- hidden canvas for preprocessing -->
      <canvas id="work" width="640" height="480" style="display:none"></canvas>
    </div>
    <div class="status" id="status">Idle. No camera yet.</div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="toolbar">
      <button id="copyBtn">Copy for Excel</button>
      <button id="csvBtn" class="ghost">Download CSV</button>
      <button id="clearBtn" class="warn">Clear today</button>
      <span class="small" id="totals" style="margin-left:auto">0 items, 0 scans</span>
    </div>
    <div class="table-wrap">
      <table id="table">
        <thead><tr><th style="width:60%">Barcode</th><th style="width:20%">Qty</th><th style="width:20%">Actions</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="status small">Copy uses tabs so Excel or Sheets paste cleanly. CSV exports include today’s date.</div>
  </div>

  <p class="notice small">
    Tips: keep 15–25 cm distance, fill the blue frame, steady for 0.5 sec. Use torch or zoom if labels are dull. Host over HTTPS. Add to Home Screen for full-screen.
  </p>
  <footer></footer>
</div>

<script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>

<script>
/* ---------- storage & table ---------- */
(function(){
  const $ = id => document.getElementById(id);
  const $today = $('today'), $tbody = $('tbody'), $totals = $('totals'), $status = $('status');

  const S = window.__RBSCAN_STATE__ = window.__RBSCAN_STATE__ || {
    counts:{}, totalScans:0, scanCooldowns:new Map()
  };
  function todayKey(){ return new Date().toISOString().slice(0,10); }
  function storeKey(){ return 'rbscan:' + todayKey(); }
  function fmtToday(){ return new Date().toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }
  function setStatus(t){ $status.textContent = t; }

  function load(){
    const raw = localStorage.getItem(storeKey());
    if(raw){ try{ const o=JSON.parse(raw); S.counts=o.counts||{}; S.totalScans=o.totalScans||0; }catch{} }
    $today.textContent = fmtToday(); render();
  }
  function save(){ localStorage.setItem(storeKey(), JSON.stringify({counts:S.counts,totalScans:S.totalScans})); }
  function acceptOnce(code){
    const now = Date.now(), last = S.scanCooldowns.get(code)||0;
    if(now-last<700) return false; S.scanCooldowns.set(code,now); return true;
  }
  function bump(code, delta=1){
    if(!code) return;
    S.counts[code] = (S.counts[code]||0) + delta;
    if(S.counts[code]<=0) delete S.counts[code];
    if(delta>0) S.totalScans += delta;
    save(); render(); setStatus('Scanned: '+code);
  }
  function render(){
    const entries = Object.entries(S.counts).sort((a,b)=>a[0].localeCompare(b[0]));
    $tbody.innerHTML='';
    for(const [code,qty] of entries){
      const tr=document.createElement('tr');
      const tdC=document.createElement('td'); tdC.textContent=code;
      const tdQ=document.createElement('td'); tdQ.className='qty';
      const inp=document.createElement('input'); inp.type='number'; inp.min='0'; inp.value=qty;
      inp.addEventListener('change',()=>{
        const v=Math.max(0,Number(inp.value|0)); const prev=S.counts[code]||0;
        S.counts[code]=v; S.totalScans += Math.max(0, v-prev); if(v===0) delete S.counts[code];
        save(); render();
      });
      tdQ.appendChild(inp);
      const tdA=document.createElement('td');
      const minus=document.createElement('button'); minus.className='ghost'; minus.textContent='−1';
      minus.onclick=()=>bump(code,-1);
      const del=document.createElement('button'); del.className='warn'; del.style.marginLeft='6px'; del.textContent='Delete';
      del.onclick=()=>{ delete S.counts[code]; save(); render(); };
      tdA.append(minus,del);
      tr.append(tdC,tdQ,tdA); $tbody.appendChild(tr);
    }
    const totalItems=entries.length, totalQty=entries.reduce((s,[,q])=>s+q,0);
    $totals.textContent = `${totalItems} items, ${totalQty} total`;
  }

  $('copyBtn').onclick=async()=>{
    const rows = Object.entries(S.counts).sort((a,b)=>a[0].localeCompare(b[0])).map(([c,q])=>`${c}\t${q}`).join('\n');
    try{ await navigator.clipboard.writeText(rows); setStatus('Copied list to clipboard.'); }
    catch{
      const ta=document.createElement('textarea'); ta.value=rows; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); ta.remove(); setStatus('Copied list to clipboard.');
    }
  };
  $('csvBtn').onclick=()=>{
    const date=todayKey(), lines=[['Date','Barcode','Qty']];
    for(const [c,q] of Object.entries(S.counts).sort((a,b)=>a[0].localeCompare(b[0]))){ lines.push([date,c,String(q)]); }
    const csv=lines.map(r=>r.map(v=>/([",\n])/.test(v)?`"${v.replace(/"/g,'""')}"`:v).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`rbscan_${date}.csv`; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1500);
  };
  $('clearBtn').onclick=()=>{ if(confirm('Clear all scans for today?')){ S.counts={}; S.totalScans=0; save(); render(); setStatus('Cleared today.'); } };

  const $manual=$('manualInput');
  $('addManualBtn').onclick=()=>{ const v=$manual.value.trim(); if(!v) return; bump(v,1); $manual.value=''; $manual.focus(); };
  $manual.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); $('addManualBtn').click(); } });

  window.__RBSCAN_BUMP__ = (code)=>{ const v=String(code||'').trim(); if(!v) return; if(!acceptOnce(v)) return; bump(v,1); };
  window.__RBSCAN_SET_STATUS__ = setStatus;
  load();
})();
</script>

<script>
/* ---------- camera + detection (improved) ---------- */
(function(){
  const $ = id => document.getElementById(id);
  const video=$('video'), work=$('work'), ctx=work.getContext('2d');
  const startBtn=$('startBtn'), stopBtn=$('stopBtn'), flipBtn=$('flipBtn'), torchBtn=$('torchBtn');
  const forceZX=$('forceZX'), useROI=$('useROI'), formatsSel=$('formats'), zoomRange=$('zoom');
  const setStatus = window.__RBSCAN_SET_STATUS__ || function(){};

  const S = window.__RBSCAN_STATE__ = window.__RBSCAN_STATE__ || {};
  Object.assign(S,{stream:null, currentDeviceId:null, running:false, detector:null, usingZX:false, _reader:null});

  function selectedFormats(){
    return Array.from(formatsSel.selectedOptions).map(o=>o.value);
  }

  async function listCameras(){
    const devs = await navigator.mediaDevices.enumerateDevices();
    return devs.filter(d=>d.kind==='videoinput');
  }

  async function startCamera(){
    if(S.stream) stopCamera();
    // push for higher res first
    const attempts = [
      [{video:{facingMode:{exact:'environment'}, width:{ideal:1920}, height:{ideal:1080}}, audio:false}, 'env 1080p'],
      [{video:{facingMode:'environment', width:{ideal:1280}, height:{ideal:720}}, audio:false}, 'env 720p'],
      [{video:{facingMode:'environment'}, audio:false}, 'env any'],
      [{video:true, audio:false}, 'any']
    ];
    if(S.currentDeviceId) attempts.unshift([{video:{deviceId:{exact:S.currentDeviceId}}, audio:false}, 'selected device']);

    let lastErr=null;
    for(const [c,label] of attempts){
      try{
        const stream=await navigator.mediaDevices.getUserMedia(c);
        S.stream=stream; video.srcObject=stream; await video.play();
        stopBtn.disabled=false;
        const cams=await listCameras(); flipBtn.disabled=cams.length<2;

        const track=stream.getVideoTracks()[0];
        const caps=track.getCapabilities?.()||{};
        torchBtn.disabled=!('torch' in caps);

        // initialize zoom control if supported
        if('zoom' in caps){
          const st=track.getSettings?.()||{};
          zoomRange.min=caps.zoom.min||1; zoomRange.max=caps.zoom.max||6; zoomRange.step=caps.zoom.step||0.1;
          zoomRange.value=st.zoom || 1;
          zoomRange.oninput=()=>track.applyConstraints({advanced:[{zoom:Number(zoomRange.value)}]});
        }else{
          zoomRange.disabled=true;
        }

        const st=track.getSettings?.(); if(st?.deviceId) S.currentDeviceId=st.deviceId;
        return;
      }catch(e){ lastErr=e; }
    }
    const name = lastErr && (lastErr.name || lastErr.cause?.name);
    setStatus(`Failed to start camera: ${name||'Unknown'}. Use HTTPS and allow Camera in Settings.`);
    throw lastErr||new Error('gUM failed');
  }

  function stopCamera(){
    if(S.stream){ S.stream.getTracks().forEach(t=>t.stop()); S.stream=null; }
    video.srcObject=null; stopBtn.disabled=true; flipBtn.disabled=true; torchBtn.disabled=true;
  }

  async function flipCamera(){
    const cams=await listCameras(); if(!cams.length) return;
    const idx=cams.findIndex(c=>c.deviceId===S.currentDeviceId);
    const next=cams[(idx+1)%cams.length]; S.currentDeviceId=next.deviceId;
    await start().catch(()=>{});
  }

  async function toggleTorch(){
    if(!S.stream) return;
    const track=S.stream.getVideoTracks()[0];
    const caps=track.getCapabilities?.()||{}; if(!('torch' in caps)) return;
    const cur=track.getConstraints()?.advanced?.[0]?.torch||false;
    await track.applyConstraints({advanced:[{torch:!cur}]});
    setStatus(!cur?'Torch on':'Torch off');
  }

  // Preprocess frame into ROI and contrast-boosted grayscale for BarcodeDetector
  function grabFrame(){
    if(video.videoWidth===0||video.videoHeight===0) return null;
    const vw=video.videoWidth, vh=video.videoHeight;
    // choose target canvas size around 720px tall for speed
    const scale = 720 / vh;
    const cw = Math.floor(vw * scale), ch = Math.floor(vh * scale);
    work.width = cw; work.height = ch;
    ctx.drawImage(video, 0, 0, cw, ch);

    if(useROI.checked){
      // center 60% x 50% region to reduce noise
      const rw = Math.floor(cw*0.6), rh = Math.floor(ch*0.5);
      const rx = Math.floor((cw-rw)/2), ry = Math.floor((ch-rh)/2);
      const img = ctx.getImageData(rx, ry, rw, rh);
      // simple contrast boost
      const d=img.data; for(let i=0;i<d.length;i+=4){
        const r=d[i], g=d[i+1], b=d[i+2];
        // luminance
        let y = (r*0.2126 + g*0.7152 + b*0.0722);
        // increase contrast
        y = Math.min(255, Math.max(0, (y-128)*1.3 + 128));
        d[i]=d[i+1]=d[i+2]=y;
      }
      ctx.putImageData(img, rx, ry);
      return ctx.getImageData(rx, ry, rw, rh);
    }else{
      return ctx.getImageData(0,0,cw,ch);
    }
  }

  let rafId=null;
  async function nativeLoop(){
    if(!S.detector) return;
    S.running=true; startBtn.disabled=true; setStatus('Scanning…');
    const loop=async()=>{
      if(!S.running) return;
      try{
        // feed processed bitmap to detector
        const img = grabFrame();
        if(img){
          // create ImageBitmap for faster path
          const bmp = await createImageBitmap(img);
          const codes = await S.detector.detect(bmp);
          if(codes?.length){
            for(const c of codes){
              const v=String(c.rawValue||'').trim(); if(v) window.__RBSCAN_BUMP__(v);
            }
          }
          bmp.close?.();
        }
      }catch{ /* keep calm and loop */ }
      rafId = requestAnimationFrame(loop);
    };
    loop();
  }

  function stopNativeLoop(){
    S.running=false; if(rafId) cancelAnimationFrame(rafId), rafId=null; startBtn.disabled=false; setStatus('Stopped.');
  }

  async function startZXing(){
    S.usingZX=true; startBtn.disabled=true;
    setStatus('Scanning with ZXing…');
    const { BrowserMultiFormatReader, BarcodeFormat, DecodeHintType } = window.ZXingBrowser || window.ZXing;

    const reader = new BrowserMultiFormatReader();
    // limit formats to user selection for faster results
    const fm = new Set(selectedFormats().map(v=>{
      const map = {
        ean_13:'EAN_13', ean_8:'EAN_8', upc_a:'UPC_A', upc_e:'UPC_E',
        code_128:'CODE_128', code_39:'CODE_39', itf:'ITF', qr_code:'QR_CODE',
        pdf417:'PDF_417', data_matrix:'DATA_MATRIX', aztec:'AZTEC', codabar:'CODABAR'
      };
      return (window.ZXing?.BarcodeFormat || BarcodeFormat)[map[v]||''];
    }).filter(Boolean));
    if(reader.setHints && window.ZXing){
      const hints = new Map();
      if(fm.size) hints.set(window.ZXing.DecodeHintType.POSSIBLE_FORMATS, Array.from(fm));
      hints.set(window.ZXing.DecodeHintType.TRY_HARDER, true);
      reader.setHints(hints);
    }
    S._reader=reader;
    reader.decodeFromVideoDevice(S.currentDeviceId, video, (res)=>{
      const txt = res?.getText ? String(res.getText()).trim() : '';
      if(txt) window.__RBSCAN_BUMP__(txt);
    });
    stopBtn.disabled=false;
  }

  async function start(){
    await startCamera();
    if(forceZX.checked || !('BarcodeDetector' in window)){
      await startZXing(); return;
    }
    // Try native detector with selected formats
    try{
      const formats = selectedFormats();
      S.detector = new window.BarcodeDetector({formats: formats.length?formats:undefined});
    }catch{
      // some iOS builds throw here if any format unsupported
      S.detector = new window.BarcodeDetector();
    }
    await nativeLoop();
  }

  function stop(){
    if(S.usingZX){
      if(S._reader){ try{ S._reader.reset(); }catch{} S._reader=null; }
      S.usingZX=false; startBtn.disabled=false; setStatus('Stopped.');
    }
    stopNativeLoop(); stopCamera();
  }

  startBtn.onclick=()=>start().catch(()=>{});
  stopBtn.onclick=()=>stop();
  flipBtn.onclick=()=>flipCamera();
  torchBtn.onclick=()=>toggleTorch();

  // keep video alive on resume
  document.addEventListener('visibilitychange', ()=>{
    if(document.visibilityState==='visible' && S.stream && video.paused){ video.play().catch(()=>{}); }
  });

  // pinch-to-zoom on the video area (if camera supports it, we map to range)
  const videoWrap = document.getElementById('videoWrap');
  let pinchStartDist=null, pinchStartZoom=null;
  videoWrap.addEventListener('touchstart', e=>{
    if(e.touches.length===2 && !zoomRange.disabled){
      const dx=e.touches[0].clientX - e.touches[1].clientX;
      const dy=e.touches[0].clientY - e.touches[1].clientY;
      pinchStartDist=Math.hypot(dx,dy);
      pinchStartZoom=Number(zoomRange.value)||1;
    }
  }, {passive:true});
  videoWrap.addEventListener('touchmove', e=>{
    if(e.touches.length===2 && pinchStartDist && !zoomRange.disabled){
      const dx=e.touches[0].clientX - e.touches[1].clientX;
      const dy=e.touches[0].clientY - e.touches[1].clientY;
      const dist=Math.hypot(dx,dy);
      const factor = dist/pinchStartDist;
      const target = Math.min(Number(zoomRange.max), Math.max(Number(zoomRange.min), pinchStartZoom*factor));
      zoomRange.value = target;
      // apply instantly if supported
      try{
        const track=S.stream?.getVideoTracks?.()[0];
        track?.applyConstraints?.({advanced:[{zoom:Number(target)}]});
      }catch{}
    }
  }, {passive:true});
})();
</script>
</body>
</html>