<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="viewport-fit=cover,width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>ranvexsi barcode scanner</title>

<!-- Minimal inline manifest so Add to Home Screen behaves -->
<link rel="manifest" href='data:application/manifest+json,{"name":"ranvexsi barcode scanner","short_name":"RBS","start_url":".","display":"standalone","background_color":"#0f1220","theme_color":"#5e7bff"}'>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
:root{
  --bg:#0f1220; --card:#171b2e; --ink:#eaf0ff; --muted:#a8b2d1; --line:#262c46; --accent:#5e7bff;
  --safe-top: env(safe-area-inset-top,0px);
  --safe-bottom: env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--ink);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
header{
  position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#121633,rgba(18,22,51,.7));
  padding: calc(8px + var(--safe-top)) 14px 10px; border-bottom:1px solid var(--line);
  display:flex; align-items:center; gap:10px; justify-content:space-between;
}
h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.2px}
.badge{font-size:11px;color:#cfd7ff;opacity:.8}
.wrap{padding:14px}
.card{
  background:var(--card); border:1px solid var(--line); border-radius:14px; overflow:hidden;
}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:10px;border-bottom:1px solid var(--line);background:#141836}
button{
  appearance:none;border:1px solid transparent;background:var(--accent);color:#fff;
  padding:9px 12px;border-radius:10px;font-weight:600;font-size:14px;cursor:pointer
}
button.ghost{background:transparent;border-color:#2f3761;color:#cbd3ff}
button.warn{background:#b54747}
button:disabled{opacity:.5;pointer-events:none}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.input{
  background:#0f1330;border:1px solid #2b3261;border-radius:10px;padding:10px 12px;color:var(--ink);
}
.video-wrap{position:relative;background:#0b0e22}
video{width:100%;height:auto;background:#000}
.scan-frame{
  position:absolute;inset:10% 15%;border:2px solid rgba(94,123,255,.8);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.35) inset;
  pointer-events:none
}
.status{padding:10px;font-size:12px;color:#c5ccef;border-top:1px dashed var(--line)}
.table-wrap{max-height:40vh;overflow:auto;border-top:1px solid var(--line)}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid var(--line)}
th{text-align:left;color:#cfd6ff;background:#141836;position:sticky;top:0;z-index:1}
td.qty input{width:70px;text-align:center}
footer{height:calc(12px + var(--safe-bottom))}
.kv{display:flex;gap:6px;align-items:center}
.kv code{background:#0f1330;border:1px solid #2b3261;border-radius:6px;padding:3px 6px;color:#cbd3ff}
.small{font-size:12px;color:#aeb7d9}
.notice{padding:10px;color:#e9edff;background:#262f5e;border-left:3px solid var(--accent);margin-top:12px}
</style>
</head>
<body>
<header>
  <div>
    <h1>ranvexsi barcode scanner</h1>
    <div class="badge">Scan. Count. Copy. Today only.</div>
  </div>
  <div class="kv small"><span>Today:</span><code id="today"></code></div>
</header>

<div class="wrap">
  <div class="card" id="scannerCard">
    <div class="toolbar">
      <div class="row">
        <button id="startBtn">Start camera</button>
        <button id="stopBtn" class="ghost" disabled>Stop</button>
        <button id="flipBtn" class="ghost" disabled>Flip camera</button>
        <button id="torchBtn" class="ghost" disabled>Toggle torch</button>
      </div>
      <div class="row">
        <input id="manualInput" class="input" placeholder="Enter barcode manually" inputmode="numeric" autocomplete="off">
        <button id="addManualBtn" class="ghost">Add</button>
      </div>
    </div>
    <div class="video-wrap">
      <video id="video" playsinline muted></video>
      <div class="scan-frame"></div>
    </div>
    <div class="status" id="status">Idle. No camera yet.</div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="toolbar">
      <button id="copyBtn">Copy for Excel</button>
      <button id="csvBtn" class="ghost">Download CSV</button>
      <button id="clearBtn" class="warn">Clear today</button>
      <span class="small" id="totals" style="margin-left:auto">0 items, 0 scans</span>
    </div>
    <div class="table-wrap">
      <table id="table">
        <thead><tr><th style="width:60%">Barcode</th><th style="width:20%">Qty</th><th style="width:20%">Actions</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="status small">Tip: “Copy for Excel” uses tab-separated values that paste cleanly into Excel or Sheets.</div>
  </div>

  <p class="notice small">
    Works best over HTTPS. Add to Home Screen for a full-screen feel. All data stays local for the current date.
  </p>
  <footer></footer>
</div>

<!-- ZXing fallback (used only if BarcodeDetector is missing) -->
<script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>

<script>
/* -------------------------
   App state, storage, table
--------------------------*/
(function(){
  const $ = id => document.getElementById(id);
  const $today = $('today');
  const $tbody = $('tbody');
  const $totals = $('totals');
  const $status = $('status');

  // Shared state object so the camera module can reuse it
  const S = window.__RBSCAN_STATE__ = window.__RBSCAN_STATE__ || {
    counts:{}, totalScans:0, scanCooldowns:new Map()
  };

  function todayKey(){ return new Date().toISOString().slice(0,10); }
  function storeKey(){ return 'rbscan:' + todayKey(); }
  function fmtToday(){
    const d = new Date();
    return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
  }

  function load(){
    const raw = localStorage.getItem(storeKey());
    if(raw){
      try{
        const obj = JSON.parse(raw);
        S.counts = obj.counts || {};
        S.totalScans = obj.totalScans || 0;
      }catch{}
    }
    $today.textContent = fmtToday();
    render();
  }
  function save(){
    localStorage.setItem(storeKey(), JSON.stringify({counts:S.counts, totalScans:S.totalScans}));
  }

  function bump(code, delta=1){
    if(!code) return;
    S.counts[code] = (S.counts[code]||0) + delta;
    if(S.counts[code] <= 0) delete S.counts[code];
    if(delta>0) S.totalScans += delta;
    save(); render(); setStatus(`Scanned: ${code}`);
  }

  function render(){
    const entries = Object.entries(S.counts).sort((a,b)=>a[0].localeCompare(b[0]));
    $tbody.innerHTML = '';
    for(const [code,qty] of entries){
      const tr = document.createElement('tr');

      const tdCode = document.createElement('td');
      tdCode.textContent = code;

      const tdQty = document.createElement('td'); tdQty.className = 'qty';
      const input = document.createElement('input');
      input.type = 'number'; input.min = '0'; input.value = qty;
      input.addEventListener('change', ()=>{
        const v = Math.max(0, Number(input.value|0));
        const prev = S.counts[code]||0;
        S.counts[code] = v;
        S.totalScans += Math.max(0, v - prev);
        if(v===0) delete S.counts[code];
        save(); render();
      });
      tdQty.appendChild(input);

      const tdAct = document.createElement('td');
      const minus = document.createElement('button'); minus.className='ghost'; minus.textContent='−1';
      minus.addEventListener('click', ()=>bump(code,-1));
      const del = document.createElement('button'); del.className='warn'; del.style.marginLeft='6px'; del.textContent='Delete';
      del.addEventListener('click', ()=>{ delete S.counts[code]; save(); render(); });
      tdAct.append(minus, del);

      tr.append(tdCode, tdQty, tdAct);
      $tbody.appendChild(tr);
    }
    const totalItems = entries.length;
    const totalQty = entries.reduce((s, [,q])=>s+q,0);
    $totals.textContent = `${totalItems} items, ${totalQty} total`;
  }

  function setStatus(msg){ try{ $status.textContent = msg; }catch{} }

  // Excel copy and CSV
  $('copyBtn').addEventListener('click', ()=>{
    const rows = Object.entries(S.counts)
      .sort((a,b)=>a[0].localeCompare(b[0]))
      .map(([c,q])=>`${c}\t${q}`).join('\n');
    const write = async () => {
      try{ await navigator.clipboard.writeText(rows); setStatus('Copied list to clipboard.'); }
      catch{
        const ta = document.createElement('textarea'); ta.value = rows;
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
        setStatus('Copied list to clipboard.');
      }
    };
    write();
  });

  $('csvBtn').addEventListener('click', ()=>{
    const date = todayKey();
    const lines = [['Date','Barcode','Qty']];
    for(const [c,q] of Object.entries(S.counts).sort((a,b)=>a[0].localeCompare(b[0]))){
      lines.push([date,c,String(q)]);
    }
    const csv = lines.map(r=>r.map(v=>/([",\n])/.test(v)?`"${v.replace(/"/g,'""')}"`:v).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `rbscan_${date}.csv`; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  });

  $('clearBtn').addEventListener('click', ()=>{
    if(confirm('Clear all scans for today?')){
      S.counts = {}; S.totalScans = 0; save(); render(); setStatus('Cleared today.');
    }
  });

  // Manual add
  const $manual = $('manualInput');
  $('addManualBtn').addEventListener('click', ()=>{
    const v = $manual.value.trim(); if(!v) return;
    bump(v,1); $manual.value=''; $manual.focus();
  });
  $manual.addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); $('addManualBtn').click(); }
  });

  // Debounce duplicate rapid scans across modules
  function acceptScanOnce(code){
    const now = Date.now();
    const last = S.scanCooldowns.get(code) || 0;
    if(now - last < 800) return false;
    S.scanCooldowns.set(code, now);
    return true;
  }

  // Expose hooks for the camera module
  window.__RBSCAN_BUMP__ = (code)=>{
    const v = String(code||'').trim();
    if(!v) return;
    if(!acceptScanOnce(v)) return;
    bump(v,1);
  };
  window.__RBSCAN_SET_STATUS__ = setStatus;

  // iOS quirk: keep video playing when tab returns (camera module also guards this)
  document.addEventListener('visibilitychange', ()=>{
    // no-op here; camera module handles video
  });

  load();
})();
</script>

<script>
/* -------------------------------------
   Robust camera + detector module (iOS)
--------------------------------------*/
(function(){
  const $ = id => document.getElementById(id);
  const $video = $('video');
  const $start = $('startBtn');
  const $stop  = $('stopBtn');
  const $flip  = $('flipBtn');
  const $torch = $('torchBtn');
  const setStatus = window.__RBSCAN_SET_STATUS__ || function(){};

  const S = window.__RBSCAN_STATE__ = window.__RBSCAN_STATE__ || {};
  Object.assign(S, {
    stream:null, usingZXing:false, detector:null, currentDeviceId:null, running:false, _reader:null
  });

  function isSecureOrigin(){
    return location.protocol === 'https:' || location.hostname === 'localhost';
  }

  async function listCameras(){
    const devs = await navigator.mediaDevices.enumerateDevices();
    return devs.filter(d => d.kind === 'videoinput');
  }

  async function tryGet(constraints, label){
    try{
      const s = await navigator.mediaDevices.getUserMedia(constraints);
      setStatus(`Camera started (${label}).`);
      return s;
    }catch(e){
      console.warn('getUserMedia failed:', label, e.name, e.message);
      const err = new Error(label); err.cause = e; throw err;
    }
  }

  async function startCamera(){
    if(S.stream) stopCamera();

    const attempts = [
      [{video:{facingMode:{exact:'environment'}}, audio:false}, 'environment exact'],
      [{video:{facingMode:'environment'}, audio:false}, 'environment'],
      [{video:true, audio:false}, 'any camera']
    ];
    if(S.currentDeviceId){
      attempts.unshift([{video:{deviceId:{exact:S.currentDeviceId}}, audio:false}, 'selected device']);
    }

    let lastError = null;
    for(const [c,label] of attempts){
      try{
        const stream = await tryGet(c,label);
        S.stream = stream;
        $video.srcObject = stream;
        await $video.play();

        $stop.disabled = false;
        const cams = await listCameras();
        $flip.disabled = cams.length < 2;

        const track = stream.getVideoTracks()[0];
        const caps = track.getCapabilities?.() || {};
        $torch.disabled = !('torch' in caps);

        const settings = track.getSettings?.();
        if(settings?.deviceId) S.currentDeviceId = settings.deviceId;

        return;
      }catch(err){ lastError = err; }
    }

    const name = lastError?.cause?.name;
    if(!isSecureOrigin()){
      setStatus('Camera blocked: page is not HTTPS. Host over HTTPS or use localhost.');
    }else if(name === 'NotAllowedError'){
      setStatus('Camera blocked by permission. Check Settings > Safari > Camera and in-page Website Settings.');
    }else if(name === 'NotFoundError'){
      setStatus('No camera found. Simulator or camera-disabled profile?');
    }else if(name === 'OverconstrainedError'){
      setStatus('Back camera unavailable with requested settings. Try Flip.');
    }else{
      setStatus(`Failed to start camera: ${name || 'Unknown error'}.`);
    }
    throw lastError || new Error('getUserMedia failed');
  }

  function stopCamera(){
    if(S.stream){
      S.stream.getTracks().forEach(t=>t.stop());
      S.stream = null;
    }
    $video.srcObject = null;
    $stop.disabled = true; $flip.disabled = true; $torch.disabled = true;
  }

  async function toggleTorch(){
    if(!S.stream) return;
    const track = S.stream.getVideoTracks()[0];
    const caps = track.getCapabilities?.() || {};
    if(!('torch' in caps)) return;
    const cur = track.getConstraints()?.advanced?.[0]?.torch || false;
    await track.applyConstraints({advanced:[{torch: !cur}]});
    setStatus(!cur ? 'Torch on' : 'Torch off');
  }

  async function flipCamera(){
    const cams = await listCameras();
    if(!cams.length) return;
    const idx = cams.findIndex(c => c.deviceId === S.currentDeviceId);
    const next = cams[(idx + 1) % cams.length];
    S.currentDeviceId = next.deviceId;
    await start().catch(()=>{});
  }

  async function start(){
    try{
      await startCamera();

      if('BarcodeDetector' in window){
        const formats = ['code_128','code_39','ean_13','ean_8','upc_a','upc_e','itf','codabar','qr_code','pdf417','aztec','data_matrix'];
        S.detector = new window.BarcodeDetector({formats});
        S.running = true; $start.disabled = true;
        setStatus('Scanning…');
        const loop = async ()=>{
          if(!S.running) return;
          try{
            const codes = await S.detector.detect($video);
            if(codes?.length){
              for(const c of codes){
                const v = String(c.rawValue||'').trim();
                if(v) window.__RBSCAN_BUMP__(v);
              }
            }
          }catch{}
          requestAnimationFrame(loop);
        };
        loop();
      }else{
        S.usingZXing = true; $start.disabled = true;
        setStatus('Scanning with ZXing…');
        const { BrowserMultiFormatReader } = window.ZXingBrowser || window.ZXing;
        const reader = new BrowserMultiFormatReader();
        S._reader = reader;
        reader.decodeFromVideoDevice(S.currentDeviceId, $video, (res)=>{
          const txt = res?.getText ? String(res.getText()).trim() : '';
          if(txt) window.__RBSCAN_BUMP__(txt);
        });
      }
    }catch(e){
      // status already set; keep Start enabled for retry
    }
  }

  function stop(){
    S.running = false;
    if(S._reader){ try{ S._reader.reset(); }catch{} S._reader = null; }
    stopCamera();
    $start.disabled = false;
    setStatus('Stopped.');
  }

  // Wire buttons
  $start.addEventListener('click', start);
  $stop.addEventListener('click', stop);
  $flip.addEventListener('click', flipCamera);
  $torch.addEventListener('click', toggleTorch);

  // Keep video alive on resume
  document.addEventListener('visibilitychange', ()=>{
    if(document.visibilityState==='visible' && S.stream && $video.paused){
      $video.play().catch(()=>{});
    }
  });
})();
</script>
</body>
</html>